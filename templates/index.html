<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Control Lab IO Remote, v1.0.0, January 28, 2024. App created by Diego Baca © 2024. www.controllab.io -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <!--Icons-->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/assets/favicon-16x16.png">

    <title>Control Lab IO</title>
    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!-- Material Icons (Materialize) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Material Symbols Outlined -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <style>
        /* Page background color */
        body {
            background-color: #F4F4F4;
        }

        .container {
            width: 100%;
            max-width: 900px;
        }

        /* Output container with light grey border and white background */
        .output-container {
            border: 1px solid #e0e0e0;
            /* Light grey border */
            padding: 15px 0;
            margin-bottom: 10px;
            /* Spacing between each output container */
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            /* White background for the output container */
            max-width: 550px;
        }

        /* Style for On/Off buttons */
        .on-off-btn {
            background-color: black;
            /* Set background color to black */
            color: white;
            /* Set text color to white */
        }

        .connection-container {
            display: flex;
            /* Use flexbox layout */
            justify-content: space-between;
            /* Space between child elements */
            align-items: center;
            /* Center items vertically */
            padding: 15px;
            /* Add some padding */
            background-color: #F4F4F4;
            /* Match the page background */
            border: none;
            /* No border */
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10px;
            /* Spacing between this container and whatever comes next */
            position: sticky;
            /* Make the container sticky */
            top: 0;
            /* Stick to the top of the viewport */
            z-index: 1000;
            /* Ensure it's above other content */
        }

        .connection-container .flex-grow {
            flex-grow: 1;
            /* Allow this element to grow and take up available space */
            display: flex;
            /* Use flexbox layout */
            justify-content: center;
            /* Center the button horizontally */
        }

        /* Custom style for the title container */
        .title-container {
            background-color: #212529;
            /* Dark background */
            color: white;
            /* White text */
            padding: 20px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10px;
            /* Spacing between title container and connection container */
            display: flex;
            /* Align items horizontally */
            align-items: center;
            /* Align items vertically */
        }

        .logo-image {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .title-text {
            margin: 0;
            /* Remove margin to align title properly */
        }

        .power-level-display .material-symbols-outlined {
            font-size: 48px;
            /* Increased size */
            vertical-align: middle;
            /* Align with text if necessary */
        }

        .row {
            display: flex;
            /* Use flexbox layout */
            align-items: center;
            /* Vertically center items in the container */
            justify-content: space-between;
            /* Distribute space between items */
            width: 100%;
            /* Ensure the row takes full width of its parent */
            margin-bottom: 0px;
        }

        .col.s1,
        .col.s11 {
            display: flex;
            /* Use flexbox layout */
            align-items: center;
            /* Align items vertically in the center */
            justify-content: center;
            /* Center items horizontally */
        }

        .col.s1 {
            flex: 1;
            /* Take 1 portion of the space */
        }

        .col.s11 {
            flex: 11;
            /* Take 11 portions of the space */
            justify-content: space-evenly;
            /* Distribute space evenly between the buttons */
        }

        .on-off-btn {
            margin-left: 10px;
            /* Left padding */
            margin-right: 10px;
            /* Right padding */
        }

        .footer-container {
            background-color: #F4F4F4;
            /* Match the page background */
            color: #B0B0B0;
            /* Light gray color for the text */
            padding: 10px 0 30px 0;
            /* Some padding */
            width: 100%;
            text-align: center;
            /* Align text to the center */
            border: none;
            /* No border */
            margin-left: auto;
            margin-right: auto;
        }

        .footer-container small {
            font-size: smaller;
            /* Small font size for the text */
        }

        /* Style for disabled On/Off buttons */
        .btn-floating.on-off-btn:disabled {
            color: white !important;
            /* Set text color to white, use !important to override */
            cursor: not-allowed !important;
            /* Optional: Change cursor to indicate the button is not clickable, use !important to override */
        }

        /* Style for outputs in two columns when the viewport is at least 800px wide */
        @media screen and (min-width: 850px) {
            .outputs-row {
                display: flex;
                flex-wrap: wrap;
                margin-left: -15px;
                /* Adjust as necessary */
                margin-right: -15px;
                /* Adjust as necessary */
            }

            .column {
                width: 50%;
                /* Set the width for each column */
                padding: 0 10px;
                /* Space between the columns */
                box-sizing: border-box;
            }

            .output-container {
                margin-bottom: 20px;
                /* Space between each output container */
            }
        }
    </style>


    <script>
        var isConnected = false;  // Initialize the isConnected variable
        var isAttemptingConnection = false; // Global flag to track connection attempts
        var isDisconnecting = false; // Global flag to track disconnection attempts
        var is_sending = false; // Initialize the is_sending variable if needed

        function sendCommand(url, output_id) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                console.log('Command sent: ' + url);
                if (output_id === 0) {
                    updateConnectionStatus();
                } else {
                    updateButtonStates(output_id);
                    updateDirectionLabels();
                    updateOnOffLabels();
                }
            };
            if (url === '/toggle_connection') {
                var connectionButton = document.getElementById('connection-btn');
                var connectionIcon = document.getElementById('connection-icon');

                // Transition to "Default / Disconnected" state if currently in "Connected" state
                if (isConnected) {
                    connectionButton.classList.add('black');
                    connectionButton.classList.remove('green', 'red', 'pulse');
                    connectionIcon.textContent = 'link';
                    isConnected = false;
                } else {
                    // Transition to "Looking for connection" state from any other state
                    connectionButton.classList.add('black', 'pulse');
                    connectionButton.classList.remove('red', 'green');
                    connectionIcon.textContent = 'link';
                    isAttemptingConnection = true;
                    isDisconnecting = false;
                }
            }
            xhr.send();
        }

        function updateButtonStates() {
            var xhrPowerLevels = new XMLHttpRequest();
            xhrPowerLevels.open("GET", "/get_power_levels", true);
            xhrPowerLevels.onload = function () {
                var dataPower = JSON.parse(xhrPowerLevels.responseText);
                var powerLevels = dataPower.power_levels;

                for (var i = 1; i <= 8; i++) {
                    var powerLevelIcon = 'counter_' + (powerLevels[i - 1] + 1);
                    document.getElementById('power-level-' + i).innerHTML = '<span class="material-symbols-outlined">' + powerLevelIcon + '</span>';
                    // Enable/disable increase and decrease buttons based only on connection status and power levels
                    document.getElementById('increase-' + i).disabled = !isConnected || (powerLevels[i - 1] == 7);
                    document.getElementById('decrease-' + i).disabled = !isConnected || (powerLevels[i - 1] == 0);
                }
            };
            xhrPowerLevels.send();
        }

        function updateDirectionLabels() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/get_direction_states", true);
            xhr.onload = function () {
                var data = JSON.parse(xhr.responseText);
                var directionStates = data.direction_states;

                for (var i = 1; i <= 8; i++) {
                    var directionIcon = document.getElementById('direction-icon-' + i);
                    if (directionStates[i - 1]) {
                        directionIcon.textContent = 'rotate_right'; // Icon for "Right"
                    } else {
                        directionIcon.textContent = 'rotate_left'; // Icon for "Left"
                    }
                }
            };
            xhr.send();
        }

        function updateOnOffLabels() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/get_on_off_states", true);
            xhr.onload = function () {
                var data = JSON.parse(xhr.responseText);
                console.log("Received On/Off States:", data);  // Debugging line
                var onOffStates = data.on_off_states;

                for (var i = 1; i <= 8; i++) {
                    var onOffButton = document.getElementById('on-off-' + i);
                    var onOffLabel = onOffStates[i - 1] ? 'On' : 'Off';
                    onOffButton.textContent = onOffLabel;

                    onOffButton.classList.remove('red', 'green', 'orange', 'pulse'); // Remove all classes
                    if (onOffLabel === 'On') {
                        if (is_sending) {
                            onOffButton.classList.add('green');
                            if (is_sending) onOffButton.classList.add('pulse');  // Add pulse only if is_sending is true
                        } else {
                            onOffButton.classList.add('orange');
                        }
                    } else {
                        onOffButton.classList.add('red');
                    }
                }

                // Call updateButtonStates after updating on-off labels to ensure buttons reflect the new on-off states
                updateButtonStates();
            };
            xhr.send();
        }

        function updateConnectionStatus() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/get_connection_status", true);
            xhr.onload = function () {
                var data = JSON.parse(xhr.responseText);
                var connectionButton = document.getElementById('connection-btn');
                var connectionIcon = document.getElementById('connection-icon');

                if (data.is_connected) {
                    // "Connected" state
                    connectionButton.classList.add('green');
                    connectionButton.classList.remove('black', 'red', 'pulse');
                    connectionIcon.textContent = 'power_settings_new';
                    isConnected = true;
                } else {
                    if (isAttemptingConnection) {
                        // "No connection found" state
                        connectionButton.classList.add('red');
                        connectionButton.classList.remove('black', 'green', 'pulse');
                        connectionIcon.textContent = 'refresh';
                    } else {
                        // "Default / Disconnected" state
                        connectionButton.classList.add('black');
                        connectionButton.classList.remove('green', 'red', 'pulse');
                        connectionIcon.textContent = 'link';
                    }
                    isConnected = false;
                }

                isAttemptingConnection = false;
                isDisconnecting = false;
                updateButtonAccessibility(data.is_connected);
                updateButtonStates();

                // Now also handle sending status
                is_sending = data.is_sending;  // Update is_sending based on the server response
                updateSendingStatus();  // Update the sending button UI
            };
            xhr.send();
        }

        function toggleSending() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/toggle_sending", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                console.log('Sending state toggled');
                updateSendingStatus();
            };
            xhr.send();
        }

        function updateSendingStatus() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/get_sending_status", true);
            xhr.onload = function () {
                var data = JSON.parse(xhr.responseText);
                is_sending = data.is_sending;  // Update the is_sending variable
                var sendingButton = document.getElementById('sending-btn');
                var sendingIcon = document.getElementById('sending-icon');

                // Update button classes and icon based on sending status
                if (is_sending) {
                    sendingButton.classList.add('green', 'pulse'); // Add green color and pulse effect
                    sendingButton.classList.remove('black', 'orange'); // Remove black and orange color
                    sendingIcon.textContent = 'play_arrow'; // Use the play_arrow icon

                    // Change any orange on/off buttons to green and add pulse
                    for (var i = 1; i <= 8; i++) {
                        var onOffButton = document.getElementById('on-off-' + i);
                        if (onOffButton.textContent === 'On') {
                            onOffButton.classList.add('green', 'pulse');
                            onOffButton.classList.remove('orange');
                        }
                    }
                } else {
                    sendingButton.classList.add('orange'); // Add orange color
                    sendingButton.classList.remove('green', 'black', 'pulse'); // Remove green color, black color, and pulse effect
                    sendingIcon.textContent = 'pause'; // Use the pause icon

                    // Change any green on/off buttons to orange and remove pulse
                    for (var i = 1; i <= 8; i++) {
                        var onOffButton = document.getElementById('on-off-' + i);
                        if (onOffButton.textContent === 'On') {
                            onOffButton.classList.add('orange');
                            onOffButton.classList.remove('green', 'pulse');
                        }
                    }
                }
            };
            xhr.send();
        }

        // Global variable to store the saved state
        var savedState = {
            On: [],
            Dir: [],
            Pow: []
        };

        function saveOutputValues() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/save_state", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log("State saved successfully.");
                } else {
                    console.log("Failed to save state.");
                }
            };
            xhr.send();
        }

        function loadOutputValues() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/load_state", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log("State loaded successfully.");
                    // Update UI based on the loaded state
                    updateButtonStates(0);
                    updateDirectionLabels();
                    updateOnOffLabels();
                } else {
                    console.log("Failed to load state.");
                }
            };
            xhr.send();
        }

        function updateButtonAccessibility(isConnected) {
            var buttons = document.querySelectorAll('.btn-floating'); // Select all floating buttons
            var outputLabels = document.querySelectorAll('.output-label'); // Select all output labels
            var powerIcons = document.querySelectorAll('.power-level-display'); // Select all power level display icons

            buttons.forEach(function (button) {
                // Disable all buttons except the connection button when disconnected
                if (button.id !== 'connection-btn') {
                    button.disabled = !isConnected;
                }
            });

            // Change color of output labels and power icons based on connection status
            outputLabels.forEach(function (label) {
                label.style.color = isConnected ? 'black' : '#E9E9E9'; // Default color when connected, grey when disconnected
            });

            powerIcons.forEach(function (icon) {
                icon.style.color = isConnected ? 'black' : '#E9E9E9'; // Default color when connected, grey when disconnected
            });
        }

        // Function to check the connection status periodically
        function periodicallyCheckConnection() {
            setInterval(function () {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/check_connection", true);
                xhr.onload = function () {
                    var data = JSON.parse(xhr.responseText);
                    if (!data.is_connected && isConnected) {
                        // If the connection was lost, update the UI to reflect this change
                        isConnected = false;
                        is_sending = data.is_sending;  // Update is_sending based on the server response
                        updateConnectionStatus();
                        updateButtonAccessibility(isConnected);
                        updateSendingStatus();  // Update the sending button UI
                    }
                };
                xhr.send();
            }, 2000); // Check every 2000 milliseconds (2 seconds)
        }

        window.onload = function () {
            // Fetch and set the initial state of is_sending
            updateSendingStatus(); // Fetch and update sending status on page load

            // Update other UI elements based on the initial state
            updateButtonStates(0);
            updateConnectionStatus();
            updateDirectionLabels();
            updateOnOffLabels();

            // Initially, assume disconnected and disable buttons
            updateButtonAccessibility(false);
            // Start checking the connection status periodically
            periodicallyCheckConnection();

        };        
    </script>

</head>

<body>
    <div class="container">
        <!-- Custom container for Title with Image -->
        <div class="title-container">
            <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Logo" class="logo-image">
            <h5 class="title-text">Control Lab IO</h5>
        </div>

        <!-- Custom container for Connection, Sending, Save, and Load Buttons -->
        <div class="connection-container">
            <!-- Connection Button (Left aligned) -->
            <button id="connection-btn" onclick="sendCommand('/toggle_connection', 0)"
                class="btn-floating btn-large black">
                <i class="material-icons" id="connection-icon">power_settings_new</i> <!-- Default icon -->
            </button>
            <!-- Sending Button (Centered) -->
            <div class="flex-grow">
                <button id="sending-btn" onclick="toggleSending()" class="btn-floating btn-large black">
                    <i class="material-icons" id="sending-icon">send</i> <!-- Default icon -->
                </button>
            </div>
            <!-- Save and Load Buttons (Right aligned) -->
            <div>
                <button id="save-btn" onclick="saveOutputValues()" class="btn-floating btn-large black">
                    <i class="material-icons">save</i> <!-- Save icon -->
                </button>
                <button id="load-btn" onclick="loadOutputValues()" class="btn-floating btn-large black">
                    <i class="material-icons">folder</i> <!-- Folder icon -->
                </button>
            </div>
        </div>

        <!-- Wrapper for output containers -->
        <div class="outputs-row">
            <!-- Column 1 for outputs 1-4 -->
            <div class="column">
                {% for output_id in range(1, 5) %}
                <div class="output-container">
                    <div class="row">
                        <!-- Output Label as a single letter (small column) -->
                        <div class="col s1">
                            <h5 class="output-label">{{ ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'][output_id - 1] }}</h5>
                        </div>
                        <!-- Buttons (larger column) -->
                        <div class="col s11">
                            <button id="on-off-{{ output_id }}"
                                onclick="sendCommand('/toggle_on/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large on-off-btn">On</button>
                            <button id="direction-{{ output_id }}"
                                onclick="sendCommand('/toggle_dir/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large black">
                                <i class="material-icons" id="direction-icon-{{ output_id }}">rotate_right</i>
                                <!-- Default icon -->
                            </button>
                            <button id="decrease-{{ output_id }}"
                                onclick="sendCommand('/decrease_power/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large black">
                                <i class="material-icons">remove_circle</i>
                            </button>
                            <span id="power-level-{{ output_id }}" class="power-level-display">
                                <span class="material-symbols-outlined">counter_1</span>
                            </span>
                            <button id="increase-{{ output_id }}"
                                onclick="sendCommand('/increase_power/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large black">
                                <i class="material-icons">add_circle</i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Column 2 for outputs 5-8 -->
            <div class="column">
                {% for output_id in range(5, 9) %}
                <div class="output-container">
                    <div class="row">
                        <!-- Output Label as a single letter (small column) -->
                        <div class="col s1">
                            <h5 class="output-label">{{ ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'][output_id - 1] }}</h5>
                        </div>
                        <!-- Buttons (larger column) -->
                        <div class="col s11">
                            <button id="on-off-{{ output_id }}"
                                onclick="sendCommand('/toggle_on/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large on-off-btn">On</button>
                            <button id="direction-{{ output_id }}"
                                onclick="sendCommand('/toggle_dir/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large black">
                                <i class="material-icons" id="direction-icon-{{ output_id }}">rotate_right</i>
                                <!-- Default icon -->
                            </button>
                            <button id="decrease-{{ output_id }}"
                                onclick="sendCommand('/decrease_power/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large black">
                                <i class="material-icons">remove_circle</i>
                            </button>
                            <span id="power-level-{{ output_id }}" class="power-level-display">
                                <span class="material-symbols-outlined">counter_1</span>
                            </span>
                            <button id="increase-{{ output_id }}"
                                onclick="sendCommand('/increase_power/{{ output_id }}', {{ output_id }})"
                                class="btn-floating btn-large black">
                                <i class="material-icons">add_circle</i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Custom container for Footer -->
        <div class="footer-container">
            <small>Control Lab IO © 2024</small>
        </div>
    </div>
</body>

</html>
